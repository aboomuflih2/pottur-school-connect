{
  "functions": [
    {
      "routine_name": "audit_trigger_function",
      "routine_definition": "\r\nBEGIN\r\n    IF TG_OP = 'DELETE' THEN\r\n        INSERT INTO audit_logs (user_id, table_name, action, record_id, old_values)\r\n        VALUES (auth.uid(), TG_TABLE_NAME, TG_OP, OLD.id, to_jsonb(OLD));\r\n        RETURN OLD;\r\n    ELSIF TG_OP = 'UPDATE' THEN\r\n        INSERT INTO audit_logs (user_id, table_name, action, record_id, old_values, new_values)\r\n        VALUES (auth.uid(), TG_TABLE_NAME, TG_OP, NEW.id, to_jsonb(OLD), to_jsonb(NEW));\r\n        RETURN NEW;\r\n    ELSIF TG_OP = 'INSERT' THEN\r\n        INSERT INTO audit_logs (user_id, table_name, action, record_id, new_values)\r\n        VALUES (auth.uid(), TG_TABLE_NAME, TG_OP, NEW.id, to_jsonb(NEW));\r\n        RETURN NEW;\r\n    END IF;\r\n    RETURN NULL;\r\nEND;\r\n",
      "routine_type": "FUNCTION",
      "data_type": "trigger"
    },
    {
      "routine_name": "is_admin",
      "routine_definition": "\r\nBEGIN\r\n  RETURN EXISTS (\r\n    SELECT 1 FROM user_roles \r\n    WHERE user_id = auth.uid() \r\n    AND role = 'admin'\r\n  );\r\nEND;\r\n",
      "routine_type": "FUNCTION",
      "data_type": "boolean"
    },
    {
      "routine_name": "update_updated_at_column",
      "routine_definition": "\r\nBEGIN\r\n    NEW.updated_at = NOW();\r\n    RETURN NEW;\r\nEND;\r\n",
      "routine_type": "FUNCTION",
      "data_type": "trigger"
    }
  ],
  "count": 3
}